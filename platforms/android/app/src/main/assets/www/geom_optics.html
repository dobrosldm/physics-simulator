<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
        <!--<meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">-->
        <link rel="stylesheet" type="text/css" href="css/index.css">
        <link rel="stylesheet" type="text/css" href="css/geom_optics.css">
        <title>Геометрическая оптика</title>

    </head>
    <body>
        <div id="canvas-container">
            <h1>Геометрическая оптика</h1>
            <canvas id="canvas" width="400" height="400"></canvas>
        </div>

        <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
        <script type="text/javascript" src="js/touchToCursor.js"></script>

        <script type="text/javascript">

            const RAY_CENTER = { x: 200, y: 200 };

            let cur_angle = Math.PI * 0.25;
            let is_cur_down = false;

            let n1 = 1;
            let n2 = 1.5;

            function onLoad() {
                setupCanvas();
                updateCanvasSize();
                redraw();
            }

            function setupCanvas() {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');

                canvas.onmousedown = canvMouseDown;
                canvas.onmouseup = canvMouseUp;
                canvas.onmousemove = canvMouseMove;
                TouchToCursor(canvas);
            }

            function updateCanvasSize() {
                const canvas = document.getElementById('canvas');

                let size = Math.min(window.innerWidth, window.innerHeight - 60);

                canvas.style.width = size + 'px';
                canvas.style.height = size + 'px';
            }

            function redraw() {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');

                drawSubstances(ctx);
                drawArrow(ctx, RAY_CENTER, cur_angle, 150, 'in');
                drawArrow(ctx, RAY_CENTER, -cur_angle, 150, 'out', '#FF00AA');
            }

            function drawSubstances(ctx) {
                // substance 1
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, 400, 400);

                ctx.font = "15px Arial";
                ctx.fillStyle = "#222222";
                ctx.fillText("n1", 10, 190);

                // substance 2
                ctx.fillStyle = "#E5E5FF";
                ctx.fillRect(0, 200, 400, 200);

                ctx.font = "15px Arial";
                ctx.fillStyle = "#222222";
                ctx.fillText("n2", 10, 390);

                // line between
                ctx.beginPath();
                ctx.strokeStyle = "#000000";
                ctx.moveTo(0, 200);
                ctx.lineTo(400, 200);
                ctx.stroke();
                ctx.closePath();

                // dashed line
                ctx.beginPath();
                ctx.strokeStyle = "#000000";
                ctx.setLineDash([5, 3]);
                ctx.moveTo(200, 50);
                ctx.lineTo(200, 350);
                ctx.stroke();
                ctx.closePath();

                ctx.setLineDash([1, 0]);
            }

            function calcSecondPoint(point, angle, length) {
                const width1 = 0;
                const height1 = -length;
                const width2 = Math.cos(angle) * width1 - Math.sin(angle) * height1;
                const height2 = Math.sin(angle) * width1 + Math.cos(angle) * height1;

                return { x: point.x - width2, y: point.y + height2 };
            }

            function drawAngledLine(ctx, point, angle, length, style = "#00AA00") {
                const p2 = calcSecondPoint(point, angle, length);

                ctx.beginPath();
                ctx.strokeStyle = style;
                ctx.moveTo(p2.x, p2.y);
                ctx.lineTo(point.x, point.y);
                ctx.stroke();
                ctx.closePath();
            }

            function drawArrow(ctx, point, angle, length, where, style = "#00AA00") {
                drawAngledLine(ctx, point, angle, length, style);
                if (where == 'in') {
                    drawAngledLine(ctx, point, angle + 0.3, 14, style);
                    drawAngledLine(ctx, point, angle - 0.3, 14, style);
                }
                else if (where == 'out') {
                    const p2 = calcSecondPoint(point, angle, length);
                    drawAngledLine(ctx, p2, angle + Math.PI + 0.3, 14, style);
                    drawAngledLine(ctx, p2, angle + Math.PI - 0.3, 14, style);
                }
            }

            function calcAngle(mouseX, mouseY) {
                let dx = RAY_CENTER.x - mouseX;
                let dy = RAY_CENTER.y - mouseY;

                if (dx <= 0.001)
                    dx = 0.001;

                if (dy > 0)
                    return Math.atan(dx / dy);
                else if (dy == 0)
                    return Math.PI / 2;
                else
                    return Math.PI / 2 - Math.atan(dy / dx);
            }

            function canvMouseDown(e) {
                is_cur_down = true;
            }

            function canvMouseUp(e) {
                is_cur_down = false;
            }

            function canvMouseMove(e) {
                let canvas = e.target;
                let rect = canvas.getBoundingClientRect();
                let clickX = (e.clientX - rect.left) / (canvas.clientWidth / canvas.width);
                let clickY = (e.clientY - rect.top) / (canvas.clientHeight / canvas.height);

                if (is_cur_down) {
                    cur_angle = calcAngle(clickX, clickY);
                    redraw();
                }
            }

            window.onload = function() {
                onLoad();
            }

            document.addEventListener("deviceready", onLoad, false);

            window.onresize = function(e) {
                updateCanvasSize();
            }
        </script>
    </body>
    </html>
